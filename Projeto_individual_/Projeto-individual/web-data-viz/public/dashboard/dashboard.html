<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard | Demon Slayer</title>

    <link rel="stylesheet" href="../css/dashboard.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="carregarDashboard()">

    <header>
    Dashboard Demon Slayer – Estatísticas do Jogo da Memória!
    </header>

    <div class="container">

        <div class="card">
            <h2>Jogadas por partida</h2>
            <canvas id="graficoJogadas"></canvas>
        </div>

        <div class="card">
            <h2>Tempo de conclusão</h2>
            <canvas id="graficoTempo"></canvas>
        </div>

        <div class="card">
            <h2>Você x Média dos Jogadores</h2>
            <canvas id="graficoComparativo"></canvas>
        </div>

    </div>

</body>

</html>

<script>

    function carregarDashboard() {
        obterPartidas();
        obterResumo();
    }

    function obterPartidas() {
        fetch(`/partidas/listar/${sessionStorage.ID_USUARIO}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id_usuario:sessionStorage.ID_USUARIO})
            })
            .then(res => res.json())
            .then(dados => {
                montarGraficoJogadas(dados);
                montarGraficoTempo(dados);
            })
            .catch(err => console.log("Erro ao buscar partidas:", err));
    }
    
    function obterResumo() {
        fetch(`/partidas/dashboard/ ${sessionStorage.ID_USUARIO}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(res => res.json())
            .then(dados => {
                montarGraficoComparativo(dados[0]);
            });
    }

    function montarGraficoJogadas(partidas) {
        const ctx = document.getElementById('graficoJogadas');

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: partidas.map(p => "Partida " + p.idPartida),
                datasets: [{
                    label: "Jogadas",
                    data: partidas.map(p => p.jogadas),
                    backgroundColor: "#29ffaf88",
                    borderColor: "#29ffaf",
                    borderWidth: 2
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "#fff" } } },
                scales: {
                    x: { ticks: { color: "#fff" } },
                    y: { ticks: { color: "#fff" } }
                }
            }
        });
    }

    function montarGraficoTempo(partidas) {
        const ctx = document.getElementById('graficoTempo');

        new Chart(ctx, {
            type: "line",
            data: {
                labels: partidas.map(p => "Partida " + p.idPartida),
                datasets: [{
                    label: "Segundos",
                    data: partidas.map(p => p.tempo),
                    borderColor: "#ff5050",
                    backgroundColor: "#ff505055",
                    borderWidth: 2
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "#fff" } } },
                scales: {
                    x: { ticks: { color: "#fff" } },
                    y: { ticks: { color: "#fff" } }
                }
            }
        });
    }

    function montarGraficoComparativo(r) {
        const ctx = document.getElementById('graficoComparativo');

        const dados = {
            labels: ["Acertos", "Jogadas", "Melhor Tempo (quanto menor melhor)"],
            datasets: [
                {
                    label: "Você",
                    data: [r.media_acertos, r.media_jogadas, r.melhor_tempo],
                    backgroundColor: "#29ffaf",
                },
                {
                    label: "Média dos Jogadores",
                    data: [8, 22, 30],
                    backgroundColor: "#ff5050"
                }
            ]
        };

        new Chart(ctx, {
            type: "radar",
            data: dados,
            options: {
                scales: {
                    r: {
                        grid: { color: "#666" },
                        angleLines: { color: "#666" },
                        pointLabels: { color: "#fff" }
                    }
                },
                plugins: { legend: { labels: { color: "#fff" } } }
            }
        });
    }
</script>