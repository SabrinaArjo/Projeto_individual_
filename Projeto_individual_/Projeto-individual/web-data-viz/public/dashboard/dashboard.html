<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard | Demon Slayer Memory</title>

    <link rel="stylesheet" href="../css/dashboard.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Sessão -->
    <script src="../js/sessao.js"></script>
</head>

<body onload="carregarDashboard()">

    <div class="container">

        <header>
            <h1>Castelo Infinito — Dashboard</h1>
            <h2>Olá, <span id="b_usuario"></span>!</h2>
        </header>

        <section class="cards-info">
            <div class="card-info">
                <h3>Total de Partidas</h3>
                <p id="totalPartidas">0</p>
            </div>

            <div class="card-info">
                <h3>Média de Jogadas</h3>
                <p id="mediaJogadas">0</p>
            </div>

            <div class="card-info">
                <h3>Melhor Tempo</h3>
                <p id="melhorTempo">0s</p>
            </div>
        </section>

        <section class="graficos">
            <canvas id="graficoJogadas"></canvas>
            <canvas id="graficoTempo"></canvas>
            <canvas id="graficoComparativo"></canvas>
        </section>
    </div>
</body>

</html>

<script>

    function carregarDashboard() {

        const idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/partidas/dashboard/${idUsuario}`)
            .then(res => res.json())
            .then(dados => {
                document.getElementById("totalPartidas").innerText = dados[0].total_partidas;
                document.getElementById("mediaJogadas").innerText = Number(dados[0].media_jogadas).toFixed(1);
                document.getElementById("melhorTempo").innerText = dados[0].melhor_tempo + "s";

                carregarGraficos(idUsuario);
            });
    }

    function carregarGraficos(idUsuario) {
        fetch(`/partidas/listar/${idUsuario}`)
            .then(res => res.json())
            .then(lista => {
                let labels = lista.map(l => l.dataHora);
                let jogadas = lista.map(l => l.jogadas);
                let tempo = lista.map(l => l.tempo);

                graficoJogadas(labels, jogadas);
                graficoTempo(labels, tempo);

                carregarComparativo(idUsuario);
            });
    }

    function graficoJogadas(labels, jogadas) {
        new Chart(document.getElementById("graficoJogadas"), {
            type: "line",
            data: {
                labels,
                datasets: [{
                    label: "Jogadas por partida",
                    data: jogadas,
                    borderWidth: 3,
                    borderColor: "#d4af37",
                    backgroundColor: "rgba(212,175,55,0.3)"
                }]
            }
        });
    }

    function graficoTempo(labels, tempo) {
        new Chart(document.getElementById("graficoTempo"), {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Tempo por partida (s)",
                    data: tempo,
                    backgroundColor: "rgba(200,30,30,0.7)",
                    borderColor: "#ff0000",
                    borderWidth: 2
                }]
            }
        });
    }

    function carregarComparativo(idUsuario) {
        fetch(`/partidas/dashboard/${idUsuario}`)
            .then(res => res.json())
            .then(stats => {

                let user_acertos = stats[0].media_acertos;
                let user_jogadas = stats[0].media_jogadas;

                fetch("/partidas/media-geral")
                    .then(res => res.json())
                    .then(media => {

                        new Chart(document.getElementById("graficoComparativo"), {
                            type: "bar",
                            data: {
                                labels: ["Acertos", "Jogadas"],
                                datasets: [
                                    {
                                        label: "Você",
                                        data: [user_acertos, user_jogadas],
                                        backgroundColor: "rgba(212,175,55,0.8)"
                                    },
                                    {
                                        label: "Média Geral",
                                        data: [media.media_acertos, media.media_jogadas],
                                        backgroundColor: "rgba(150,150,150,0.5)"
                                    }
                                ]
                            }
                        });

                    });
            });
    }

</script>